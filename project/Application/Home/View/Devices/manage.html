<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1" >

<script src="__PUBLIC__/Home/js/jquery-1.8.3.min.js"></script>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/mobileStyle.css">
<script src="__PUBLIC__/Home/js/flexible.js"></script>
<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
<link rel="stylesheet" href="__PUBLIC__/Home/css/all-devices.css">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/iconfontHome.css">
<script src="__PUBLIC__/Home/js/jweixin-1.2.0.js"></script>	
<title>绑定指引</title>
<style>
	body {
		width: 100vw;
		height: 100vh;
	}
	#devices-list>ul>b {
		background: #039CE9;
	}
	#devices-list>h3,
	#devices-list>ul>li,
	#devices-add>p {
		font-size: 0.473333rem;
	}
	#devices-add>p {
		color: #039CE9 !important;
	}
	#devices-add {
		width: 100%;
		height: 8%;
		display: flex;
		color: #039CE9 !important;
		align-items: center;
		z-index: 999;
	}
	#back2Home {
	    width: 8vh;
	    height: 8vh;
	    display: -webkit-flex;
	    display: -moz-flex;
	    display: -ms-flex;
	    display: -o-flex;
	    display: flex;
	    justify-content: center;
	    -ms-align-items: center;
	    align-items: center;
	    position: absolute;
	    right: 0;
	    top: -10px;
	    z-index: 999;
	}
	#back2Home:active {
	    background: #ccc;
	}
	#back2Home>i {
	    width: 5vh;
	    height: 5vh;
	    text-align: center;
	    line-height: 5vh;
	    color: #fff;
		font-weight: 600;
	    border-radius: 5vh;
	    background: #039CE9;
	}
</style>
<script>	
		$(function(){
			$('#devices-list li').bind('click',function(){
				var device_code = $(this).attr('title');
				var _this = this;
				$.post('{{:U("Home/Devices/setNowDevices")}}',{ 'device_code':device_code }, function(res){
					// 判断购物车是否添加成功
					if(res==1){
						$('#devices-list ul li i').removeClass('iconfont icon-chenggong');
						$(_this).children('i').addClass('iconfont icon-chenggong');	
					}
				});
	
			});	
		});

		$(function(){
			$('#devices-add').bind({
				'mouseover' : function () { 

				$(this).css('color','#FF8600');
				},
				'mouseout' : function () {
				$(this).css('color','#ccc');
				}
			});
		});
	</script>

</head>
<body>
<div id="devices-all">
	<a id="back2Home" href="{{:U('Home/index/index')}}"><i class="iconfont icon-zhuye"></i></a>
	<div id="devices-container">
		<div id="devices-list">
			<h3>所有设备</h3>
			<ul>
				<foreach name="devices"	item="value">				
					<if condition="$currentDevices['did'] == $value['id'] ">
							<!-- 用户当前设备 -->
							<b></b><li title="{{$value['device_code']}}">设备型号:{{$value['device_code']}}<i class="iconfont icon-chenggong"></i></li><br>
					    <else />
					    	<b></b><li title="{{$value['device_code']}}">设备型号:{{$value['device_code']}}<i></i></li><br>
					</if>
				</foreach>
			</ul>
		</div>	
	</div>
	<div id="devices-add" style="color: #000;background: #F1F1F1">
		<!-- <i class="iconfont icon-jiahao"></i><p><a href="{{:U('Home/WaterPurifier/binding')}}">添加设备</a></p> -->
		<i class="iconfont icon-jiahao"></i><p>添加设备</p>
	</div>
</div>
<script>
	//微信接口
	wx.config({
	    debug: false,
	    appId: '{{$info["appId"]}}',
	    timestamp: '{{$info["timestamp"]}}',
	    nonceStr: '{{$info["nonceStr"]}}',
	    signature: '{{$info["signature"]}}',
	    jsApiList: [
	      // 所有要调用的 API 都要加到这个列表中
	      'configWXDeviceWiFi', 
	      'scanQRCode'
	    ]
	});	
	// 扫码绑定设备
	$("#devices-add").click(function(){
		wx.scanQRCode({
		    needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
		    scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
		    success: function (res) {
		    	if (res.errMsg === "scanQRCode:ok"){
			    	// 当needResult 为 1 时，扫码返回的结果
				    $.ajax({
				    	url:"{{:U('Home/Devices/bind')}}",
				    	type:"post",
				    	data:{device_code:res.resultStr},
				    	dataType:'json',
				    	success:function(data){
				    		if(data==1){
				    			// 绑定成功，跳转到填写用户安装信息
				    			window.location.href = "{{:U('Home/Users/personalinformation')}}?"+new Date().getTime();
				    		}else if(data==-1){
				    			alert('设备不存在！');
				    		}else if(data==-2){
				    			alert('设备已被绑定！');
				    		}else{
				    			alert('设备绑定失败！');
				    		}
	
				    	},
				    	error:function(jqXHR, textStatus, errorThrown){
		    				alert("绑定失败" + jqXHR.status + textStatus + errorThrown);
				    		//console.log(jqXHR.status);
				    	}
				    });
				    //alert(res.resultStr);
			    }
			}
		});
	});

</script>

</body>
</html>