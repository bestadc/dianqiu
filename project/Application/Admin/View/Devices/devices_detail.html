<include file="Public/header" />
<div class="content" style="background-color: #ECF0F5">
    <include file="Public/nav" />
        <div class="row-fluid fl" id="main" style="margin-bottom: 50px">
            <div style="padding: 0 15px;">
                 <div class="titleBar">设备管理/<span>设备列表/设备详情</span>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:history.go(-1)" class="btn btn-info">&lt;&lt;返回</a></div>
                <h1 class="text-center _dev">当前设备：</h1>
                <div class="clearfix" style="background-color: #ECF0F5;margin-left: 1%">
                    <div style="margin: 15px 0;" class="_dive">
                        <div class="_four _margin-right _DD4B39 text-center">
                            <h1 class="_h1 _text">--</h1>
                            <span class="_text">设备当前状态</span>
                        </div>
                        <div class="_four _margin-right _337AB7 text-center">
                            <h1 class="_h1 _text">--</h1>
                            <span class="_text">设备当前原水值(ppm)</span>
                        </div>
                        <div class="_four _margin-right _05CE3E text-center">
                            <h1 class="_h1 _text">--</h1>
                            <span class="_text">设备当前净水值(ppm)</span>
                        </div>
                        <div class="_four _77E1FB text-center">
                            <h1 class="_h1 _text">--</h1>
                            <span class="_text">设备当前租赁模式</span>
                        </div>
                    </div> 
                </div>
                <div class="clearfix">
                    <div class="_float_left">
                        <div class="_device">
                            <div>
                                <h3>滤芯信息(剩余值)</h3>
                            </div>
                            <table class="table _table" style="margin-bottom: 0">

                            </table>
                        </div>

                        <div class="_device">
                            <div>
                                <h3>设备操作</h3>
                                <div style="padding: 0 100px"><button class="btn btn-primary" style="padding:15px 25px">关机</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="_float_right">
                        <div style="padding: 5px 10px;" class="_device">
                            <div>
                                <h3>设备信息</h3>
                            </div>
                            <table class="table _table2">

                            </table>
                        </div>
                    </div>
                </div>
                <div class="_tb">
                    <h2>经销商信息列表</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <td>经销商ID</td>
                                <td>经销商姓名</td>
                                <td>手机号码</td>
                                <td>地址</td>
                                <td>管理级别</td>
                                <td>邮箱</td>
                            </tr>
                        </thead>
                        <tbody class="_vendor">
                            
                        </tbody>
                    </table>
                </div>
              
                <script>
                    var devicestause = {
                        '0':'制水',
                        '1':'冲洗',
                        '2':'水满',
                        '3':'缺水',
                        '4':'漏水',
                        '5':'检修',
                        '6':'欠费停机',
                        '7':'关机',
                        '8':'开机(仅命令)'
                    }
                    var leasingmode = {
                        '0':'零售型',
                        '1':'按流量计费',
                        '2':'按时间计费',
                        '3':'时长和流量套餐',
                        '4':'商务型'
                    }
                    var filtermode = {
                        '0':'按时长',
                        '1':'按流量',
                        '2':'时长和流量'
                    }
                    $.ajax({
                        url:'__URL__/deviceDetail?code=' + location.hash.slice(1),
                        type:'get',
                        error:function(err){
                            console.log('err',err)
                        },
                        success:function(data){
                            console.log(data)
                            //设备
                            $('._dev').append(location.hash.slice(1)+'设备详情')
                            var $status = $('._dive div h1')
                            var $_table = $('._table')
                            var $_table2 = $('._table2')
                            $status.eq(0).html(devicestause[data.statu.devicestause]?devicestause[data.statu.devicestause]:'--')
                            $status.eq(1).html(data.statu.puretds?data.statu.puretds:'--')
                            $status.eq(2).html(data.statu.rawtds?data.statu.rawtds:'--')
                            $status.eq(3).html(data.statu.leasingmode?leasingmode[data.statu.leasingmode]:'--')
                            //滤芯信息
                            var _color = ['#05CE3E','#005384','#DD4B39','#337AB7','#5CB85C','#77E1FB']
                            data.filterInfo.forEach(function(el,i){
                                var persent1 = Number(data.statu[('reflowfilter'+(i+1))])/Number(el.flowlife)*100
                                var persent2 = Number(data.statu[('redayfilter'+(i+1))])/Number(el.timelife)*100
                                var persent = Math.min(persent1,persent2)
                                var _bool = persent == persent1?true:false
                                var width = Math.min(persent,100)
                                var html = '<tr>'+
                                            '<td>'+el.filtername+'&nbsp;(&nbsp;'+el.alias+'&nbsp;)&nbsp;'+'</td>'+
                                            '<td style="width:50%">'+
                                                '<div class="text-center">'+
                                                    '<div class="_progress">'+
                                                        '<div class="_progress_" style="width: '+width+'%;background-color:'+_color[i%_color.length]+'">'+
                                                        '</div>'+
                                                    '</div>'+
                                                    '<span>还剩'+width.toFixed(2)+'%</span>'+
                                                '</div>'+
                                            '</td>'+
                                            '<td>'+(_bool?Number(data.statu[('reflowfilter'+(i+1))]):Number(data.statu[('redayfilter'+(i+1))]))+'/'+(_bool?el.flowlife:el.timelife)+'</td>'+
                                            '<td>'+'<tutton class="btn btn-info">复位</button>'+'</td>'+
                                            '</tr>'
                                $_table.append(html)
                            })
                            //设备信息
                            var _devicestause = devicestause[data.statu.devicestause]?devicestause[data.statu.devicestause]:'--'
                            var _address = data.statu.address?data.statu.address:'--'
                            var _deviceid = location.hash.slice(1)
                            var _puretds = data.statu.puretds?data.statu.puretds:'--'
                            var _rawtds = data.statu.rawtds?data.statu.rawtds:'--'
                            var _reflow = data.statu.reflow?data.statu.reflow:'--'
                            var _reday = data.statu.reday?data.statu.reday:'--'
                            var html2 = '<tr>'+
                                            '<td>'+'设备编号'+'</td>'+
                                            '<td>'+_deviceid+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'设备状态'+'</td>'+
                                            '<td>'+_devicestause+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'安装时间'+'</td>'+
                                            '<td>'+(data.statu.addtime?new Date(data.statu.addtime*1000).toLocaleString():'--')+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'安装地址'+'</td>'+
                                            '<td>'+_address+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'原水值(ppm)'+'</td>'+
                                            '<td>'+_puretds+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'纯水值(ppm)'+'</td>'+
                                            '<td>'+_rawtds+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'剩余流量 (L)'+'</td>'+
                                            '<td>'+_reflow+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'剩余天数 (D)'+'</td>'+
                                            '<td>'+_reday+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'租赁模式'+'</td>'+
                                            '<td>'+(data.statu.leasingmode?leasingmode[data.statu.leasingmode]:'--')+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'激活状态'+'</td>'+
                                            '<td>'+(Number(data.statu.alivestause)?'已激活':'未激活')+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'滤芯模式'+'</td>'+
                                            '<td>'+(data.statu.filtermode?filtermode[data.statu.filtermode]:'--')+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'温度'+'</td>'+
                                            '<td>'+(data.statu.temperature?data.statu.temperature:'--')+'</td>'+
                                        '</tr>'+
                                        '<tr>'+
                                            '<td>'+'更新时间'+'</td>'+
                                            '<td>'+(data.statu.updatetime?new Date(data.statu.updatetime*1000).toLocaleString():'--')+'</td>'+
                                        '</tr>'
                            $_table2.append(html2)
                            //经销商列表
                            if(data.vendor){
                                var _html3 = '<tr>'+
                                            '<td>'+(data.vendor.id?data.vendor.id:'--')+'</td>'+
                                            '<td>'+(data.vendor.name?data.vendor.name:'--')+'</td>'+
                                            '<td>'+(data.vendor.phone?data.vendor.phone:'--')+'</td>'+
                                            '<td>'+(data.vendor.address?data.vendor.address:'--')+'</td>'+
                                            '<td>'+(data.vendor.leavel?data.vendor.leavel:'--')+'</td>'+
                                            '<td>'+(data.vendor.email?data.vendor.email:'--')+'</td>'+
                                            '</tr>'
                                $('._vendor').html(_html3)
                            }
                         
                        }
                    })
                </script>
            </div>
           
        </div>
        <include file="Public/footer" />
</div>

<script type="text/javascript">
    $(function(){
            //websoket  
    //1.建立连接
    var websoket= new WebSocket("ws://120.27.12.1:6001");
    //2.打开事件
    var deviceId=$(".deviceID").text();//设备id
    websoket.onopen=function(){
        //发送包数据
        ajson={
            "DeviceID":deviceId,
            "PackType":"login",
            "Vison":0,
        };
        websoket.send(JSON.stringify(ajson));
    }
    //实时接收数据
    websoket.onmessage=function(data){
        if(data.PackType=="Select")
        {
            $(".deviceStause").text(data.deviceStause);//设置设备状态
            $(".puretdsVal").text(data.puretds);//设置当前设备原水值
            $(".rawtdsVal").text(data.rawtds);//设置当前设备纯水值
            $(".leasingmodeVal").text(data.leasingmode);//设置当前设备租赁模式
            $(".reflow").text(data.reflow);//设置当前设备剩余流量
            $(".reday").text(data.ree);//设置当前设备滤芯模式
            $(".temperature").text(data.temperatureday);//设置当前设备剩余天数
            $(".filtermode").text(data.filtermod);//设置当前设备温度
            $(".updatetime").text(data.updatetime);//设置当前设备更新时间
        }
        else if(data.PackType=="SetData")
        {
            for(var i=0;i<CmdList.length;i++){
                if(CmdList[i].PackNum==data.PackNum)
                {
                    if(CmdList[i].type=="关机中")
                    {
                        
                    }
                    else if(CmdList[i].type=="开机中")
                    {

                    }
                    else if(CmdList[i].type=="1")
                    {
                        $(".filterInfoTable").children("tr").children("td").children("span").text(100);
                        $(".filterInfoTable").children("tr").children("td").children("div").children("p").width(100+"%");
                    }
                    else if(CmdList[i].type=="2")
                    {
                        
                    }
                    else if(CmdList[i].type=="3")
                    {
                         
                    }
                    else if(CmdList[i].type=="4")
                    {
                        
                    }
                    else if(CmdList[i].type=="5")
                    {
                        
                    }
                    CmdList.splice(i,1);
                    break;
                }
            }
        }
        else if(data.PackType=="Heart")
        {

        }
        else if(data.PackType=="login")
        {

        }
        //循环遍历设置滤芯剩余显示样式
        for(var i=1;i<=$(".filterInfoTable tbody tr").length;i++){
            var filterVal;
            if(data['reflowfilter'+i]){
                filterVal=data['reflowfilter'+i];
            }else{
                filterVal=0;
            }
            $(".filterInfoTable tbody tr").eq(i).children("td").children(".surplusShowColor").width(data['reflowfilter'+i]+"%");
            $(".filterInfoTable tbody tr").eq(i).children("td").children(".surplusNum2").text(filterVal);
        }

    }
    })
</script>